<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人中心 - 神机图鉴</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles/common.css">
    <link rel="stylesheet" href="styles/profile.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">神机图鉴</div>
            <div class="user-status">
                <!-- 用户状态将由auth.js动态更新 -->
                <a href="login.html" class="btn">登录</a>
            </div>
        </header>

        <nav>
            <ul>
                <li><a href="index.html"><i class="fas fa-home"></i> 首页</a></li>
                <li><a href="knowledge-graph.html"><i class="fas fa-project-diagram"></i> 知识图谱</a></li>
                <li><a href="qa.html"><i class="fas fa-comments"></i> 智能问答</a></li>
                <li><a href="recommendation.html"><i class="fas fa-thumbs-up"></i> 智能推荐</a></li>
                <li><a href="test.html"><i class="fas fa-bullseye"></i> 军事测验</a></li>
                <li><a href="weapon-recognition.html"><i class="fas fa-camera"></i> 武器识别</a></li>
                <li><a href="profile.html" class="active"><i class="fas fa-user"></i> 个人中心</a></li>
            </ul>
        </nav>
        <div class="content">
            <div class="card">
                <h1>个人中心</h1>
                
                <div class="profile-header">
                    <div class="profile-avatar"></div>
                    <h2 id="profileName">张三</h2>
                </div>
                
                <form id="profileForm">
                    <div class="form-group">
                        <label for="username">用户名</label>
                        <input type="text" id="username" name="username" value="张三">
                    </div>
                    <div class="form-group">
                        <label for="email">电子邮箱</label>
                        <input type="email" id="email" name="email" value="zhangsan@example.com">
                    </div>
                    <div class="form-group">
                        <label for="phone">手机号码</label>
                        <input type="tel" id="phone" name="phone" value="13800138000">
                    </div>
                    <div class="form-group">
                        <label for="bio">个人简介</label>
                        <textarea id="bio" name="bio" rows="4">我是一名军事武器爱好者，喜欢学习和分享关于军事的相关知识。</textarea>
                    </div>
                    <button type="submit">保存修改</button>
                </form>
            </div>
        </div>
    </div>
    <script>
        const API_BASE = 'http://localhost:3001/api';

        // 检查用户是否已登录并加载用户信息
        document.addEventListener('DOMContentLoaded', async function() {
            const authToken = localStorage.getItem('authToken');
            
            if (!authToken) {
                alert('请先登录');
                window.location.href = 'login.html';
                return;
            }

            try {
                console.log('正在获取用户信息...');
                
                // 从后端获取用户信息
                const response = await fetch(`${API_BASE}/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                console.log('API响应状态:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('获取到的用户数据:', data);
                    
                    if (data.success && data.data) {
                        const user = data.data;
                        
                        // 显示用户信息
                        document.getElementById('profileName').textContent = user.name || user.username;
                        document.getElementById('username').value = user.username || '';
                        document.getElementById('email').value = user.email || '';
                        document.getElementById('phone').value = user.phone || '';
                        document.getElementById('bio').value = user.bio || '';
                        
                        // 更新localStorage中的用户信息
                        localStorage.setItem('userInfo', JSON.stringify({
                            ...user,
                            isLoggedIn: true
                        }));
                        
                        console.log('用户信息加载成功');
                    } else {
                        throw new Error('用户数据格式错误');
                    }
                } else if (response.status === 401 || response.status === 403) {
                    // 令牌无效，清除本地存储并重定向到登录页面
                    console.log('令牌无效，清除本地存储');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userInfo');
                    alert('登录已过期，请重新登录');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1000);
                } else {
                    // 其他HTTP错误
                    const errorData = await response.text();
                    console.error('API错误响应:', errorData);
                    throw new Error(`服务器错误: ${response.status}`);
                }
            } catch (error) {
                console.error('获取用户信息时出错:', error);
                
                // 检查是否是网络连接问题
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    alert('无法连接到服务器，请检查网络连接或确认后端服务是否正在运行');
                } else {
                    alert('获取用户信息失败：' + error.message);
                }
                
                // 清除可能损坏的令牌
                localStorage.removeItem('authToken');
                localStorage.removeItem('userInfo');
                
                // 延迟跳转，避免无限循环
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        });

        // 处理表单提交
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('请先登录');
                window.location.href = 'login.html';
                return;
            }

            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const bio = document.getElementById('bio').value;

            try {
                // 显示加载状态
                const submitBtn = document.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '保存中...';
                submitBtn.disabled = true;

                // 发送更新请求
                const response = await fetch(`${API_BASE}/auth/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        name: username,
                        phone: phone,
                        bio: bio
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('更新响应数据:', data);

                    if (data.success) {
                        alert('个人资料保存成功！');
                        
                        // 更新页面显示
                        document.getElementById('profileName').textContent = username;
                        
                        // 更新localStorage中的用户信息
                        const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                        userInfo.name = username;
                        userInfo.phone = phone;
                        userInfo.bio = bio;
                        localStorage.setItem('userInfo', JSON.stringify(userInfo));
                    } else {
                        alert('保存失败：' + (data.message || '未知错误'));
                    }
                } else if (response.status === 401 || response.status === 403) {
                    // 令牌无效
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userInfo');
                    alert('登录已过期，请重新登录');
                    window.location.href = 'login.html';
                } else {
                    // 其他HTTP错误
                    const errorData = await response.json().catch(() => ({}));
                    alert('保存失败：' + (errorData.message || `服务器错误 ${response.status}`));
                }
            } catch (error) {
                console.error('保存个人资料时出错:', error);
                alert('保存失败，请检查网络连接或稍后重试');
            } finally {
                // 恢复按钮状态
                const submitBtn = document.querySelector('button[type="submit"]');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // 添加退出登录功能
        function logout() {
            if (confirm('确定要退出登录吗？')) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userInfo');
                alert('已退出登录');
                window.location.href = 'login.html';
            }
        }

        // 在页面加载完成后添加退出登录按钮
        document.addEventListener('DOMContentLoaded', function() {
            // 在用户状态区域添加退出登录按钮
            const userStatus = document.querySelector('.user-status');
            if (userStatus) {
                userStatus.innerHTML = `
                    <span>欢迎回来！</span>
                    <button onclick="logout()" class="btn" style="margin-left: 10px;">退出登录</button>
                `;
            }
        });
    </script>
</body>
</html>