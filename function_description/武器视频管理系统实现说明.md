# 武器视频管理系统实现说明

## 📋 功能概述

武器视频管理系统是"兵智世界"项目中的核心功能模块，为每个武器节点提供完整的视频上传、管理、播放和展示功能。系统采用前后端分离架构，实现了文件上传、进度显示、视频流播放等完整功能。

## 🏗️ 系统架构

### 前端架构
- **主要文件**: `scripts/weapon-video-integration.js`
- **样式文件**: 内嵌CSS样式系统
- **集成方式**: 与知识图谱系统无缝集成
- **技术栈**: 原生JavaScript + HTML5 Video API + XMLHttpRequest

### 后端架构
- **路由文件**: `backend/src/routes/weapon-videos.js`
- **主应用**: `backend/src/app-simple.js`
- **数据库**: SQLite (`backend/data/military-knowledge.db`)
- **文件存储**: 本地文件系统 (`backend/uploads/weapons/videos/`)
- **技术栈**: Node.js + Express.js + Multer + SQLite3

## 🎯 核心功能特性

### 1. 视频上传功能
- **多种上传方式**：
  - 点击选择文件
  - 拖拽文件到上传区域
- **文件验证**：
  - 支持格式：MP4, AVI, MOV等主流视频格式
  - 文件大小限制：最大100MB
  - 前后端双重验证
- **实时进度显示**：
  - 0%-100%实时进度条
  - 动态状态文字提示
  - 颜色状态指示（蓝色上传中→绿色成功→红色失败）

### 2. 视频管理功能
- **视频列表展示**：
  - 网格布局显示所有视频
  - 视频缩略图预览
  - 视频元信息显示（上传时间、文件大小等）
- **视频操作**：
  - 播放视频
  - 编辑视频描述
  - 删除视频
- **空状态处理**：
  - 无视频时的友好提示
  - 加载状态显示

### 3. 视频播放功能
- **全屏播放体验**：
  - 模态窗口播放
  - 支持所有HTML5视频控件
  - 键盘快捷键支持（ESC关闭）
- **信息显示优化**：
  - 手动控制信息显示/隐藏
  - 避免遮挡播放控件
  - 智能武器名称获取

### 4. 知识图谱集成
- **节点视频缩略图**：
  - 在武器节点上显示视频缩略图
  - 支持直接点击播放
  - 显示视频数量统计
- **管理入口**：
  - "管理视频"按钮
  - 无缝切换到管理界面

## 🔧 技术实现详解

### 前端核心类：WeaponVideoManager

```javascript
class WeaponVideoManager {
    constructor() {
        this.currentWeaponId = null;
        this.currentWeaponName = null;
        this.videos = [];
        this.isUploading = false;
        this.init();
    }
}
```

#### 关键方法说明：

1. **文件上传处理**
   ```javascript
   handleFileSelection(file) // 处理文件选择和验证
   uploadVideo() // 执行上传操作
   showUploadProgress() // 显示上传进度
   updateUploadProgress() // 更新进度条
   completeUpload() // 完成上传处理
   ```

2. **视频管理**
   ```javascript
   loadWeaponVideos() // 加载武器视频列表
   renderVideoGrid() // 渲染视频网格
   editVideo() // 编辑视频信息
   deleteVideo() // 删除视频
   ```

3. **视频播放**
   ```javascript
   playVideo() // 播放视频
   toggleVideoInfo() // 切换信息显示
   getWeaponNameFromContext() // 智能获取武器名称
   ```

### 后端API接口

#### 主要路由：

1. **上传视频**
   ```
   POST /api/weapon-videos/weapon/:weaponId/upload
   - 支持multipart/form-data
   - 文件验证和存储
   - 数据库记录创建
   ```

2. **获取视频列表**
   ```
   GET /api/weapon-videos/weapon/:weaponId
   - 返回指定武器的所有视频
   - 包含完整元信息
   ```

3. **视频文件服务**
   ```
   GET /api/weapon-videos/file/:filename
   - 支持HTTP Range请求
   - 视频流播放
   - 断点续传支持
   ```

4. **视频管理操作**
   ```
   PUT /api/weapon-videos/:id     // 更新视频信息
   DELETE /api/weapon-videos/:id  // 删除视频
   ```

### 数据库设计

#### weapon_videos表结构：
```sql
CREATE TABLE weapon_videos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    weapon_id INTEGER NOT NULL,
    filename VARCHAR(255) NOT NULL,
    original_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size INTEGER NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    description TEXT,
    upload_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (weapon_id) REFERENCES weapons(id)
);
```

## 🎨 用户界面设计

### 1. 管理界面
- **现代化设计**：渐变色标题栏 + 卡片式布局
- **响应式布局**：自适应网格系统
- **交互反馈**：悬停效果 + 动画过渡

### 2. 上传区域
- **拖拽上传**：虚线边框 + 拖拽状态提示
- **进度显示**：
  - 滑入动画效果
  - 渐变色进度条
  - 实时状态更新

### 3. 视频播放器
- **全屏体验**：黑色背景 + 居中播放
- **信息叠加**：渐变遮罩 + 可控显示
- **操作按钮**：圆形按钮 + 图标切换

## 🔄 前后端数据流

### 上传流程：
```
1. 用户选择文件 → 前端验证 → 显示文件信息
2. 点击上传 → 创建FormData → 显示进度条
3. XMLHttpRequest发送 → 监听progress事件 → 更新进度
4. 后端接收 → Multer处理 → 文件存储 → 数据库记录
5. 返回结果 → 前端处理 → 更新界面 → 刷新列表
```

### 播放流程：
```
1. 点击播放 → 创建播放模态窗口
2. 请求视频文件 → 后端Range响应 → 流式传输
3. HTML5 Video播放 → 支持所有控件
4. 信息显示控制 → 用户体验优化
```

## 🛡️ 安全与验证

### 文件安全
- **类型验证**：MIME类型检查
- **大小限制**：100MB上限
- **文件名安全**：时间戳重命名
- **路径安全**：相对路径存储

### 访问控制
- **简单认证**：x-admin-user头部验证
- **权限检查**：管理员权限要求
- **错误处理**：友好错误提示

## 📊 性能优化

### 前端优化
- **进度显示**：XMLHttpRequest原生支持
- **内存管理**：及时清理DOM元素
- **事件绑定**：防抖处理
- **状态管理**：上传锁定机制

### 后端优化
- **流式传输**：HTTP Range支持
- **文件缓存**：Express静态文件服务
- **数据库索引**：weapon_id索引优化
- **错误恢复**：事务处理

## 🔧 部署与配置

### 环境要求
- Node.js 14+
- SQLite3
- 文件系统写权限

### 配置文件
```javascript
// backend/src/app-simple.js
app.use('/uploads', express.static('uploads')); // 静态文件服务
app.use('/api/weapon-videos', weaponVideosRouter); // 路由注册
```

### 目录结构
```
backend/
├── uploads/weapons/videos/     # 视频文件存储
├── src/routes/weapon-videos.js # 视频路由
└── data/military-knowledge.db  # 数据库文件
```

## 🚀 功能扩展建议

### 短期优化
1. **视频压缩**：上传时自动压缩
2. **缩略图生成**：视频首帧截图
3. **批量操作**：多选删除/编辑
4. **搜索过滤**：按描述搜索视频

### 长期规划
1. **云存储集成**：OSS/S3支持
2. **视频转码**：多格式支持
3. **CDN加速**：全球分发
4. **用户权限**：细粒度权限控制

## 📝 维护说明

### 日志监控
- 上传操作日志
- 播放访问统计
- 错误异常记录

### 数据备份
- 定期数据库备份
- 视频文件备份策略
- 灾难恢复方案

### 性能监控
- 上传速度统计
- 播放流畅度监控
- 存储空间使用情况

---

## 📞 技术支持

如有问题或建议，请参考：
- 项目文档：`README.md`
- 前后端连接说明：`前后端连接实现详解.md`
- 测试页面：`test-weapon-video.html`

**版本**: v1.3  
**最后更新**: 2025年8月11日  
**维护者**: CodeBuddy AI Assistant