# 兵智世界项目 - 前后端连接实现说明

## 项目概述

本项目是一个军事武器知识管理系统，采用前后端分离架构，实现了完整的用户注册、登录、资料管理功能。

## 技术架构

### 后端技术栈
- **Node.js + Express.js**: 服务器框架
- **SQLite + better-sqlite3**: 数据库存储
- **JWT (JSON Web Token)**: 用户认证
- **bcryptjs**: 密码加密
- **CORS**: 跨域资源共享

### 前端技术栈
- **HTML5 + CSS3 + JavaScript**: 基础前端技术
- **Fetch API**: HTTP请求处理
- **LocalStorage**: 本地数据存储

## 前后端连接实现

### 1. 服务器配置

**后端服务器启动**：
```bash
cd backend
npm run dev
```
- 服务器运行在 `http://localhost:3001`
- 支持CORS跨域请求
- 提供RESTful API接口

### 2. 数据库设计

**用户表结构** (`users`):
```sql
CREATE TABLE users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT UNIQUE NOT NULL,
  email TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  name TEXT,
  phone TEXT,
  bio TEXT,
  avatar TEXT,
  role TEXT DEFAULT 'user',
  status TEXT DEFAULT 'active',
  preferences TEXT DEFAULT '{}',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  last_login DATETIME
)
```

### 3. API接口设计

#### 用户注册 API
- **接口**: `POST /api/auth/register`
- **请求体**:
```json
{
  "username": "用户名",
  "email": "邮箱",
  "password": "密码",
  "name": "姓名"
}
```
- **响应**:
```json
{
  "success": true,
  "message": "注册成功",
  "data": {
    "user": { "id": 1, "username": "...", "email": "..." },
    "token": "JWT令牌"
  }
}
```

#### 用户登录 API
- **接口**: `POST /api/auth/login`
- **请求体**:
```json
{
  "username": "用户名",
  "password": "密码"
}
```
- **响应**:
```json
{
  "success": true,
  "message": "登录成功",
  "data": {
    "user": { "id": 1, "username": "...", "email": "..." },
    "token": "JWT令牌"
  }
}
```

#### 获取用户信息 API
- **接口**: `GET /api/auth/profile`
- **请求头**: `Authorization: Bearer JWT令牌`
- **响应**:
```json
{
  "id": 1,
  "username": "用户名",
  "email": "邮箱",
  "name": "姓名",
  "phone": "电话",
  "bio": "个人简介",
  "role": "user",
  "status": "active",
  "preferences": { "theme": "light", "language": "zh-cn" },
  "created_at": "2025-07-24 14:26:01",
  "updated_at": "2025-07-24 14:54:04",
  "last_login": "2025-07-24 14:54:04"
}
```

#### 更新用户资料 API
- **接口**: `PUT /api/auth/profile`
- **请求头**: `Authorization: Bearer JWT令牌`
- **请求体**:
```json
{
  "name": "新姓名",
  "phone": "新电话",
  "bio": "新个人简介"
}
```

### 4. 前端页面实现

#### 注册页面 (`register.html`)
```javascript
// 注册表单提交
document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const userData = {
        username: formData.get('username'),
        email: formData.get('email'),
        password: formData.get('password'),
        name: formData.get('name')
    };
    
    try {
        const response = await fetch('http://localhost:3001/api/auth/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(userData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // 保存JWT令牌
            localStorage.setItem('token', result.data.token);
            localStorage.setItem('user', JSON.stringify(result.data.user));
            
            alert('注册成功！');
            window.location.href = 'profile.html';
        } else {
            alert('注册失败：' + result.message);
        }
    } catch (error) {
        console.error('注册请求失败:', error);
        alert('注册失败，请检查网络连接');
    }
});
```

#### 登录页面 (`login.html`)
```javascript
// 登录表单提交
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const loginData = {
        username: formData.get('username'),
        password: formData.get('password')
    };
    
    try {
        const response = await fetch('http://localhost:3001/api/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(loginData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // 保存JWT令牌和用户信息
            localStorage.setItem('token', result.data.token);
            localStorage.setItem('user', JSON.stringify(result.data.user));
            
            alert('登录成功！');
            window.location.href = 'profile.html';
        } else {
            alert('登录失败：' + result.message);
        }
    } catch (error) {
        console.error('登录请求失败:', error);
        alert('登录失败，请检查网络连接');
    }
});
```

#### 用户资料页面 (`profile.html`)
```javascript
// 页面加载时获取用户信息
window.addEventListener('load', async () => {
    const token = localStorage.getItem('token');
    
    if (!token) {
        alert('请先登录');
        window.location.href = 'login.html';
        return;
    }
    
    try {
        const response = await fetch('http://localhost:3001/api/auth/profile', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const userInfo = await response.json();
            // 填充用户信息到表单
            document.getElementById('username').value = userInfo.username || '';
            document.getElementById('email').value = userInfo.email || '';
            document.getElementById('name').value = userInfo.name || '';
            document.getElementById('phone').value = userInfo.phone || '';
            document.getElementById('bio').value = userInfo.bio || '';
        } else {
            throw new Error('获取用户信息失败');
        }
    } catch (error) {
        console.error('获取用户信息失败:', error);
        alert('获取用户信息失败，请重新登录');
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = 'login.html';
    }
});

// 更新用户资料
document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const token = localStorage.getItem('token');
    const formData = new FormData(e.target);
    const updateData = {
        name: formData.get('name'),
        phone: formData.get('phone'),
        bio: formData.get('bio')
    };
    
    try {
        const response = await fetch('http://localhost:3001/api/auth/profile', {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
        });
        
        if (response.ok) {
            const result = await response.json();
            alert('资料更新成功！');
            
            // 更新本地存储的用户信息
            const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
            const updatedUser = { ...currentUser, ...updateData };
            localStorage.setItem('user', JSON.stringify(updatedUser));
        } else {
            const error = await response.json();
            alert('更新失败：' + error.message);
        }
    } catch (error) {
        console.error('更新资料失败:', error);
        alert('更新失败，请检查网络连接');
    }
});
```

### 5. 身份认证机制

#### JWT令牌认证流程
1. **用户登录/注册** → 后端验证成功 → 生成JWT令牌 → 返回给前端
2. **前端存储令牌** → 保存到localStorage中
3. **后续请求** → 前端在请求头中携带 `Authorization: Bearer <token>`
4. **后端验证** → 中间件验证JWT令牌有效性 → 允许访问受保护的API

#### 中间件认证代码
```javascript
const authenticateToken = (req, res, next) => {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN

  if (!token) {
    return res.status(401).json({
      success: false,
      message: '访问令牌缺失'
    });
  }

  jwt.verify(token, config.jwt.secret, (err, user) => {
    if (err) {
      return res.status(403).json({
        success: false,
        message: '访问令牌无效或已过期'
      });
    }

    req.user = user;
    next();
  });
};
```

### 6. 数据流向图

```
前端页面 ←→ HTTP请求/响应 ←→ Express路由 ←→ 业务服务层 ←→ SQLite数据库
   ↓                           ↓              ↓              ↓
localStorage              JWT中间件        用户服务        用户表
(存储令牌)                (身份验证)      (业务逻辑)      (数据存储)
```

### 7. 安全措施

1. **密码加密**: 使用bcryptjs对密码进行哈希加密存储
2. **JWT令牌**: 使用JSON Web Token进行用户身份认证
3. **CORS配置**: 配置跨域资源共享，限制访问来源
4. **输入验证**: 对用户输入进行验证和清理
5. **错误处理**: 统一的错误处理机制，避免敏感信息泄露

### 8. 测试验证

#### API测试命令
```powershell
# 用户注册
Invoke-WebRequest -Uri "http://localhost:3001/api/auth/register" -Method POST -ContentType "application/json" -Body '{"username":"testuser","email":"test@example.com","password":"123456","name":"测试用户"}'

# 用户登录
Invoke-WebRequest -Uri "http://localhost:3001/api/auth/login" -Method POST -ContentType "application/json" -Body '{"username":"testuser","password":"123456"}'

# 获取用户信息（需要JWT令牌）
Invoke-WebRequest -Uri "http://localhost:3001/api/auth/profile" -Method GET -Headers @{"Authorization"="Bearer <JWT令牌>"}

# 更新用户资料（需要JWT令牌）
Invoke-WebRequest -Uri "http://localhost:3001/api/auth/profile" -Method PUT -ContentType "application/json" -Headers @{"Authorization"="Bearer <JWT令牌>"} -Body '{"name":"新姓名","phone":"13800138000","bio":"个人简介"}'
```

## 总结

本项目通过以下方式体现了前后端的完整连接：

1. **数据交互**: 前端通过HTTP请求与后端API进行数据交换
2. **身份认证**: 使用JWT令牌实现用户身份验证和授权
3. **状态管理**: 前端使用localStorage保存用户状态和令牌
4. **错误处理**: 完善的错误处理机制，提供用户友好的反馈
5. **数据持久化**: 后端将用户数据持久化存储到SQLite数据库
6. **安全保障**: 密码加密、令牌验证等安全措施

整个系统实现了从用户注册、登录到资料管理的完整业务流程，展示了现代Web应用前后端分离架构的典型实现方式。