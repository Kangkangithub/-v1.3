# 服务器速率限制调整说明

## 已完成的修改

我已经将API速率限制从原来的**每15分钟100个请求**提高到了**每15分钟500个请求**。

修改位置：
- `backend/src/config/index.js` 中的 `rateLimit.maxRequests` 值从 100 改为 500

## 速率限制的工作原理

在兵智世界系统中，速率限制通过以下方式实现：

1. 使用 `express-rate-limit` 中间件来控制API请求频率
2. 配置文件中定义了两个关键参数：
   - `windowMs`: 时间窗口，默认为15分钟（900000毫秒）
   - `maxRequests`: 在时间窗口内允许的最大请求数

当用户在指定时间窗口内的请求数超过限制时，服务器会返回HTTP 429状态码，表示"请求过于频繁"。

## 如何进一步调整

如果当前的调整仍然不足以解决问题，您可以考虑以下几种方式进一步优化：

### 1. 通过环境变量调整（推荐）

在项目根目录的 `.env` 文件中添加或修改以下变量：

```
RATE_LIMIT_WINDOW_MS=900000  # 时间窗口，单位为毫秒（15分钟）
RATE_LIMIT_MAX_REQUESTS=1000  # 在时间窗口内允许的最大请求数
```

这种方式不需要修改代码，重启服务器后即可生效。

### 2. 直接修改配置文件

如果需要进一步增加限制，可以再次编辑 `backend/src/config/index.js` 文件：

```javascript
rateLimit: {
  windowMs: process.env.RATE_LIMIT_WINDOW_MS || 900000, // 15分钟
  maxRequests: process.env.RATE_LIMIT_MAX_REQUESTS || 1000 // 进一步提高到1000个请求
},
```

### 3. 针对不同路由设置不同的限制

如果只有特定API路由需要更高的限制，可以在 `app.js` 和 `app-simple.js` 中为不同路由设置不同的限制：

```javascript
// 为普通API设置基本限制
const basicLimiter = rateLimit({
  windowMs: config.rateLimit.windowMs,
  max: config.rateLimit.maxRequests,
  message: { success: false, message: '请求过于频繁，请稍后再试' }
});

// 为高频API设置更宽松的限制
const highFrequencyLimiter = rateLimit({
  windowMs: config.rateLimit.windowMs,
  max: config.rateLimit.maxRequests * 2, // 两倍的请求限制
  message: { success: false, message: '请求过于频繁，请稍后再试' }
});

// 应用不同的限制
this.app.use('/api/', basicLimiter);
this.app.use('/api/weapons', highFrequencyLimiter); // 武器API使用更高的限制
```

## 监控与调优

建议在调整后监控服务器性能和API响应时间，确保提高速率限制不会对服务器性能造成负面影响。可以考虑以下几点：

1. 监控服务器CPU和内存使用情况
2. 关注数据库连接数和查询性能
3. 检查API响应时间是否有明显变化
4. 查看日志中是否有新的错误或警告

## 注意事项

1. 速率限制是防止滥用和保护服务器资源的重要机制，不建议完全移除
2. 如果客户端确实需要频繁请求，可以考虑优化前端缓存策略，减少不必要的API调用
3. 对于需要大量数据的场景，可以考虑实现批量API或分页机制，减少请求次数

## 重启服务器

修改配置后，需要重启服务器才能使新的速率限制生效：

```bash
# 如果使用Node直接运行
node backend/src/app.js

# 如果使用npm脚本
npm run start

# 如果使用简化版服务器
node backend/src/app-simple.js